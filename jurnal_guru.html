<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Input Jurnal Guru</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:Arial, sans-serif;
  background:#f4f6f8;
  padding:20px
}

#btnGantiLembaga{
  position:absolute;
  top:12px;
  right:12px;
  cursor:pointer;
  font-size:22px;
}
#btnGantiLembaga img{
  width:28px;
  height:28px;
}

#btnKamera{
  background:#1565c0;
}


.card{
  position:relative;
  max-width:640px;
  margin:auto;
  background:#fff;
  padding:20px;
  border-radius:8px
}

.file-camera{
  position:absolute;
  left:-9999px;
  width:1px;
  height:1px;
  opacity:0;
}


label{font-weight:bold;display:block;margin-top:10px}
input,select,textarea,button{
  width:100%;
  padding:8px;
  margin-top:5px;
  font-family:inherit
}
textarea{resize:vertical}
button{
  background:#2e7d32;
  color:#fff;
  border:none;
  margin-top:15px;
  cursor:pointer
}
button:disabled{background:#9e9e9e}
.logo{
  text-align:center;
  margin-bottom:10px
}
.logo img{
  max-width:120px;
  max-height:120px;
  object-fit:contain
}
.preview img{
  width:120px;
  height:120px;
  object-fit:cover;
  border:1px solid #ccc;
  margin-top:8px
}
.status{font-size:12px;color:#555;margin-top:6px}
.error{color:#c62828;font-size:12px;margin-top:6px}
.hidden{display:none}
</style>
</head>
<body>

<div class="card">

<!-- ===== LOGIN KODE LEMBAGA ===== -->
<div id="loginBox">
  <h3 align="center">Masukkan Kode Lembaga</h3>
  <input id="kodeLembaga" placeholder="Contoh: SD01">
  <button id="btnMasuk">Masuk</button>
  <div class="error" id="loginError"></div>
</div>


<!-- ===== FORM JURNAL ===== -->
<div id="formJurnal" class="hidden">


<div id="btnGantiLembaga" title="Ganti Lembaga">
  üè´
</div>


<div class="logo" id="logoBox"></div>

<h2 align="center">Input Jurnal Guru</h2>
<div id="namaLembagaTampil"
     style="text-align:center;font-weight:bold;color:#2e7d32;margin-bottom:10px">
</div>


<label>Nama Guru</label>
<select id="guru"></select>

<label>Kelas</label>
<select id="kelas"></select>

<label>Rombel</label>
<select id="rombel"></select>

<label>Mata Pelajaran</label>
<select id="mapel"></select>

<label>Catatan Pembelajaran</label>
<textarea id="catatan" rows="4"></textarea>

<label>Jumlah Siswa Hadir</label>
<input type="number" id="hadir">

<label>Jumlah Siswa Absen</label>
<input type="number" id="absen">

<label>Foto Kegiatan</label>

<div id="infoWaktu" class="error" style="display:none"></div>


<video id="video"
  autoplay
  playsinline
  style="width:100%;border:1px solid #ccc;border-radius:8px">
</video>

<button type="button" id="btnAmbil">
  üì∏ Ambil Foto
</button>

<canvas id="canvas" class="hidden"></canvas>

<div class="preview" id="preview"></div>



<button type="button" id="btnKamera">
  üì∑ Buka Kamera
</button>



<div class="preview" id="preview"></div>
<div class="status" id="status"></div>
<div class="error" id="error"></div>

<button id="btnSimpan">Simpan Jurnal</button>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs,
  query, where
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ===== FIREBASE ===== */
const firebaseConfig = {
  apiKey:"AIzaSyCcjNKkW3ASw46yKXshKIa6qkrJMNVlep8",
  authDomain:"jurnalmengajar-d4e8e.firebaseapp.com",
  projectId:"jurnalmengajar-d4e8e"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ===== APPS SCRIPT ===== */
const GAS_URL="https://script.google.com/macros/s/AKfycbwD3mIvrZMRBy3NN4iJ4FkNZ3VxfH8ucKMzImvAAGORgG0K0AxQU4h1c5zvsUb__C4K/exec";

/* ===== ELEMENT ===== */
const loginBox=document.getElementById("loginBox");
const formJurnal=document.getElementById("formJurnal");
const kodeEl=document.getElementById("kodeLembaga");
const btnMasuk=document.getElementById("btnMasuk");
const loginError=document.getElementById("loginError");
const logoBox=document.getElementById("logoBox");

const guruEl=document.getElementById("guru");
const kelasEl=document.getElementById("kelas");
const rombelEl=document.getElementById("rombel");
const mapelEl=document.getElementById("mapel");
const catatanEl=document.getElementById("catatan");
const hadirEl=document.getElementById("hadir");
const absenEl=document.getElementById("absen");

const previewEl=document.getElementById("preview");
const statusEl=document.getElementById("status");
const errorEl=document.getElementById("error");
const btnSimpan=document.getElementById("btnSimpan");
const namaLembagaTampil = document.getElementById("namaLembagaTampil");
const btnKamera = document.getElementById("btnKamera");
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const btnAmbil = document.getElementById("btnAmbil");


btnAmbil.style.display = "none";
video.style.display = "none";

let stream = null;
let fotoBlob = null;



let lembagaId="";
let namaLembaga="";

function isJamPembiasaanValid(){
  const now = new Date();
  const jam = now.getHours();
  const menit = now.getMinutes();

  const totalMenit = jam * 60 + menit;

  const mulai = 6 * 60 + 30; // 06:30
  const selesai = 7 * 60 + 5; // 07:05

  return totalMenit >= mulai && totalMenit <= selesai;
}



function sortByText(a, b){
  return a.localeCompare(b, "id", { numeric: true, sensitivity: "base" });
}





/* ===== MASUK DENGAN KODE ===== */
btnMasuk.onclick=async()=>{
  loginError.textContent="";
  const kode=kodeEl.value.trim();
  if(!kode) return;

  const q=query(collection(db,"lembaga"),where("kode","==",kode));
  const s=await getDocs(q);

 

  const d=s.docs[0];
  const x=d.data();
  lembagaId=d.id;
  namaLembaga=x.nama;

localStorage.setItem("kodeLembaga", kode);

logoBox.innerHTML = x.logo
  ? `<img src="${driveThumb(x.logo,200)}">`
  : "";
namaLembagaTampil.textContent = namaLembaga;


  loginBox.classList.add("hidden");
  formJurnal.classList.remove("hidden");



  loadGuru();
  loadKelas();
  loadMapel();
};




/* ===== LOAD DATA ===== */
async function loadGuru(){
  const q=query(collection(db,"guru"),where("lembagaId","==",lembagaId));
  const s=await getDocs(q);

  const arr=[];
  s.forEach(d=>arr.push({id:d.id,...d.data()}));
  arr.sort((a,b)=>sortByText(a.namaGuru,b.namaGuru));

  guruEl.innerHTML='<option value="">-- Pilih --</option>';
  arr.forEach(x=>{
    guruEl.innerHTML+=
      `<option value="${x.id}">${x.namaGuru}</option>`;
  });
}

async function loadKelas(){
  const q=query(collection(db,"kelas"),where("lembagaId","==",lembagaId));
  const s=await getDocs(q);

  const arr=[];
  s.forEach(d=>arr.push({id:d.id,...d.data()}));
  arr.sort((a,b)=>sortByText(a.namaKelas,b.namaKelas));

  kelasEl.innerHTML='<option value="">-- Pilih --</option>';
  arr.forEach(x=>{
    kelasEl.innerHTML+=
      `<option value="${x.id}">${x.namaKelas}</option>`;
  });
}

async function loadRombel(){
  const q=query(collection(db,"rombel"),where("kelasId","==",kelasEl.value));
  const s=await getDocs(q);

  const arr=[];
  s.forEach(d=>arr.push({id:d.id,...d.data()}));
  arr.sort((a,b)=>sortByText(a.namaRombel,b.namaRombel));

  rombelEl.innerHTML='<option value="">-- Pilih --</option>';
  arr.forEach(x=>{
    rombelEl.innerHTML+=
      `<option value="${x.id}">${x.namaRombel}</option>`;
  });
}

btnAmbil.onclick = () => {
  const w = video.videoWidth;
  const h = video.videoHeight;

  canvas.width = w;
  canvas.height = h;

  const ctx = canvas.getContext("2d");
  ctx.drawImage(video, 0, 0, w, h);

  canvas.toBlob(blob => {
    fotoBlob = blob;

    // preview hasil foto
    const url = URL.createObjectURL(blob);
    previewEl.innerHTML = `<img src="${url}" width="120">`;

  }, "image/jpeg", 0.9);


// MATIKAN KAMERA
stream.getTracks().forEach(t => t.stop());
stream = null;

// atur tampilan tombol
video.style.display = "none";
btnAmbil.style.display = "none";
btnKamera.style.display = "block";
};

async function bukaKamera(){
  stream = await navigator.mediaDevices.getUserMedia({
    video:{ facingMode:"environment" }
  });
  video.srcObject = stream;
}


async function loadMapel(){
  const s=await getDocs(collection(db,"mapel"));

  const arr=[];
  s.forEach(d=>arr.push({id:d.id,...d.data()}));
  arr.sort((a,b)=>sortByText(a.namaMapel,b.namaMapel));

  mapelEl.innerHTML='<option value="">-- Pilih --</option>';
  arr.forEach(x=>{
    mapelEl.innerHTML+=
      `<option value="${x.id}">${x.namaMapel}</option>`;
  });
}

mapelEl.onchange = () => {
  const namaMapel =
    mapelEl.options[mapelEl.selectedIndex]?.text.toLowerCase() || "";

  const info = document.getElementById("infoWaktu");

  if(namaMapel.includes("pembiasaan")){
    if(!isJamPembiasaanValid()){
      info.style.display = "block";
      info.textContent =
        "‚ùå Pembiasaan pagi hanya bisa diinput pukul 06.30 ‚Äì 07.05";

      btnKamera.disabled = true;
      btnSimpan.disabled = true;
      btnKamera.style.opacity = 0.6;
      btnSimpan.style.opacity = 0.6;
    }else{
      info.style.display = "none";
      btnKamera.disabled = false;
      btnSimpan.disabled = false;
      btnKamera.style.opacity = 1;
      btnSimpan.style.opacity = 1;
    }
  }else{
    // mapel selain pembiasaan ‚Üí bebas
    info.style.display = "none";
    btnKamera.disabled = false;
    btnSimpan.disabled = false;
    btnKamera.style.opacity = 1;
    btnSimpan.style.opacity = 1;
  }
};






btnKamera.onclick = async () => {
  await bukaKamera();

  video.style.display = "block";
  btnAmbil.style.display = "block";
  btnKamera.style.display = "none";
};



/* ===== FOTO ===== */
async function uploadFotoBlob(blob){
  statusEl.textContent="Upload foto...";

  const reader = new FileReader();
  return new Promise(res=>{
    reader.onload = async()=>{
      const o = await fetch(GAS_URL,{
        method:"POST",
        body:JSON.stringify({
          action:"upload",
          name:"jurnal_"+Date.now()+".jpg",
          mime:"image/jpeg",
          data: reader.result.split(",")[1]
        })
      });
      const j = await o.json();
      res(j.url);
    };
    reader.readAsDataURL(blob);
  });
}


/* ===== SIMPAN ===== */
btnSimpan.onclick = async()=>{

const namaMapel =
  mapelEl.options[mapelEl.selectedIndex]?.text.toLowerCase() || "";

if(namaMapel.includes("pembiasaan") && !isJamPembiasaanValid()){
  errorEl.textContent =
    "‚õî Di luar jam pembiasaan pagi (06.30 ‚Äì 07.05)";
  return;
}



  if(!fotoBlob){
    errorEl.textContent =
      "Foto kegiatan wajib diambil dari kamera";
    return;
  }

  const fotoUrl = await uploadFotoBlob(fotoBlob);

await addDoc(collection(db,"jurnal"),{
  lembagaId,
  namaLembaga,

  guruId: guruEl.value,
  namaGuru: guruEl.options[guruEl.selectedIndex]?.text || "",

  kelasId: kelasEl.value,
  namaKelas: kelasEl.options[kelasEl.selectedIndex]?.text || "",

  rombelId: rombelEl.value,
  namaRombel: rombelEl.options[rombelEl.selectedIndex]?.text || "",

  mapelId: mapelEl.value,
  namaMapel: mapelEl.options[mapelEl.selectedIndex]?.text || "",

  catatan: catatanEl.value,
  hadir: Number(hadirEl.value || 0),
  absen: Number(absenEl.value || 0),

  foto: fotoUrl,
  dibuat: new Date()
});


  alert("Jurnal tersimpan");
  location.reload();
};

kelasEl.onchange=loadRombel;


function driveThumb(url, size = 300){
  if(!url) return "";
  if(url.includes("thumbnail")) return url;
  if(url.includes("uc?id=")){
    return url.replace(
      "https://drive.google.com/uc?id=",
      "https://drive.google.com/thumbnail?id="
    ) + "&sz=w" + size;
  }
  return url;
}

window.addEventListener("load", async () => {
  const kode = localStorage.getItem("kodeLembaga");
  if(!kode) return;

  kodeEl.value = kode;
  btnMasuk.click();
});


document.getElementById("btnGantiLembaga").onclick = () => {
  if(!confirm("Ganti lembaga?")) return;
  localStorage.removeItem("kodeLembaga");
  location.reload();
};




</script>

</body>
</html>
