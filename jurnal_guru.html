<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Input Jurnal Guru</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:Arial, sans-serif;
  background:#f4f6f8;
  padding:20px
}

#btnGantiLembaga{
  position:absolute;
  top:12px;
  right:12px;
  cursor:pointer;
  font-size:22px;
}
#btnGantiLembaga img{
  width:28px;
  height:28px;
}

#btnKamera{
  background:#1565c0;
}


.card{
  position:relative;
  max-width:640px;
  margin:auto;
  background:#fff;
  padding:20px;
  border-radius:8px
}

label{font-weight:bold;display:block;margin-top:10px}
input,select,textarea,button{
  width:100%;
  padding:8px;
  margin-top:5px;
  font-family:inherit
}
textarea{resize:vertical}
button{
  background:#2e7d32;
  color:#fff;
  border:none;
  margin-top:15px;
  cursor:pointer
}
button:disabled{background:#9e9e9e}
.logo{
  text-align:center;
  margin-bottom:10px
}
.logo img{
  max-width:120px;
  max-height:120px;
  object-fit:contain
}
.preview img{
  width:120px;
  height:120px;
  object-fit:cover;
  border:1px solid #ccc;
  margin-top:8px
}
.status{font-size:12px;color:#555;margin-top:6px}
.error{color:#c62828;font-size:12px;margin-top:6px}
.hidden{display:none}
</style>
</head>
<body>

<div class="card">

<!-- ===== LOGIN KODE LEMBAGA ===== -->
<div id="loginBox">
  <h3 align="center">Masukkan Kode Lembaga</h3>
  <input id="kodeLembaga" placeholder="Contoh: SD01">
  <button id="btnMasuk">Masuk</button>
  <div class="error" id="loginError"></div>
</div>


<!-- ===== FORM JURNAL ===== -->
<div id="formJurnal" class="hidden">


<div id="btnGantiLembaga" title="Ganti Lembaga">
  üè´
</div>


<div class="logo" id="logoBox"></div>

<h2 align="center">Input Jurnal Guru</h2>
<div id="namaLembagaTampil"
     style="text-align:center;font-weight:bold;color:#2e7d32;margin-bottom:10px">
</div>


<label>Nama Guru</label>
<select id="guru"></select>

<label>Kelas</label>
<select id="kelas"></select>

<label>Rombel</label>
<select id="rombel"></select>

<label>Mata Pelajaran</label>
<select id="mapel"></select>

<label>Catatan Pembelajaran</label>
<textarea id="catatan" rows="4"></textarea>

<label>Jumlah Siswa Hadir</label>
<input type="number" id="hadir">

<label>Jumlah Siswa Absen</label>
<input type="number" id="absen">

<label>Foto Kegiatan</label>

<input
  type="file"
  id="foto"
  accept="image/*"
  capture="environment"
  class="hidden">

<button type="button" id="btnKamera">
  üì∑ Buka Kamera
</button>



<div class="preview" id="preview"></div>
<div class="status" id="status"></div>
<div class="error" id="error"></div>

<button id="btnSimpan">Simpan Jurnal</button>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs,
  query, where
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ===== FIREBASE ===== */
const firebaseConfig = {
  apiKey:"AIzaSyCcjNKkW3ASw46yKXshKIa6qkrJMNVlep8",
  authDomain:"jurnalmengajar-d4e8e.firebaseapp.com",
  projectId:"jurnalmengajar-d4e8e"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ===== APPS SCRIPT ===== */
const GAS_URL="https://script.google.com/macros/s/AKfycbwe6lo9qYfzU8EA4oFesmPQ2rKw0P01MtFK7fenc2UfRm1x_29yS_AAc2PbqRNcMfnTHA/exec";

/* ===== ELEMENT ===== */
const loginBox=document.getElementById("loginBox");
const formJurnal=document.getElementById("formJurnal");
const kodeEl=document.getElementById("kodeLembaga");
const btnMasuk=document.getElementById("btnMasuk");
const loginError=document.getElementById("loginError");
const logoBox=document.getElementById("logoBox");

const guruEl=document.getElementById("guru");
const kelasEl=document.getElementById("kelas");
const rombelEl=document.getElementById("rombel");
const mapelEl=document.getElementById("mapel");
const catatanEl=document.getElementById("catatan");
const hadirEl=document.getElementById("hadir");
const absenEl=document.getElementById("absen");
const fotoEl=document.getElementById("foto");
const previewEl=document.getElementById("preview");
const statusEl=document.getElementById("status");
const errorEl=document.getElementById("error");
const btnSimpan=document.getElementById("btnSimpan");
const namaLembagaTampil = document.getElementById("namaLembagaTampil");
const btnKamera = document.getElementById("btnKamera");



let lembagaId="";
let namaLembaga="";

function sortByText(a, b){
  return a.localeCompare(b, "id", { numeric: true, sensitivity: "base" });
}


btnKamera.onclick = () => {
  fotoEl.click();
};


/* ===== MASUK DENGAN KODE ===== */
btnMasuk.onclick=async()=>{
  loginError.textContent="";
  const kode=kodeEl.value.trim();
  if(!kode) return;

  const q=query(collection(db,"lembaga"),where("kode","==",kode));
  const s=await getDocs(q);

  if(s.empty){
    loginError.textContent="Kode lembaga tidak ditemukan";
    return;
  }

  const d=s.docs[0];
  const x=d.data();
  lembagaId=d.id;
  namaLembaga=x.nama;

localStorage.setItem("kodeLembaga", kode);

logoBox.innerHTML = x.logo
  ? `<img src="${driveThumb(x.logo,200)}">`
  : "";
namaLembagaTampil.textContent = namaLembaga;


  loginBox.classList.add("hidden");
  formJurnal.classList.remove("hidden");



  loadGuru();
  loadKelas();
  loadMapel();
};

/* ===== LOAD DATA ===== */
async function loadGuru(){
  const q=query(collection(db,"guru"),where("lembagaId","==",lembagaId));
  const s=await getDocs(q);

  const arr=[];
  s.forEach(d=>arr.push({id:d.id,...d.data()}));
  arr.sort((a,b)=>sortByText(a.namaGuru,b.namaGuru));

  guruEl.innerHTML='<option value="">-- Pilih --</option>';
  arr.forEach(x=>{
    guruEl.innerHTML+=
      `<option value="${x.id}">${x.namaGuru}</option>`;
  });
}

async function loadKelas(){
  const q=query(collection(db,"kelas"),where("lembagaId","==",lembagaId));
  const s=await getDocs(q);

  const arr=[];
  s.forEach(d=>arr.push({id:d.id,...d.data()}));
  arr.sort((a,b)=>sortByText(a.namaKelas,b.namaKelas));

  kelasEl.innerHTML='<option value="">-- Pilih --</option>';
  arr.forEach(x=>{
    kelasEl.innerHTML+=
      `<option value="${x.id}">${x.namaKelas}</option>`;
  });
}

async function loadRombel(){
  const q=query(collection(db,"rombel"),where("kelasId","==",kelasEl.value));
  const s=await getDocs(q);

  const arr=[];
  s.forEach(d=>arr.push({id:d.id,...d.data()}));
  arr.sort((a,b)=>sortByText(a.namaRombel,b.namaRombel));

  rombelEl.innerHTML='<option value="">-- Pilih --</option>';
  arr.forEach(x=>{
    rombelEl.innerHTML+=
      `<option value="${x.id}">${x.namaRombel}</option>`;
  });
}

async function loadMapel(){
  const s=await getDocs(collection(db,"mapel"));

  const arr=[];
  s.forEach(d=>arr.push({id:d.id,...d.data()}));
  arr.sort((a,b)=>sortByText(a.namaMapel,b.namaMapel));

  mapelEl.innerHTML='<option value="">-- Pilih --</option>';
  arr.forEach(x=>{
    mapelEl.innerHTML+=
      `<option value="${x.id}">${x.namaMapel}</option>`;
  });
}


/* ===== FOTO ===== */
fotoEl.onchange = () => {
  const file = fotoEl.files[0];
  if(!file) return;

  // pastikan image
  if(!file.type.startsWith("image/")){
    alert("Foto harus diambil dari kamera");
    fotoEl.value="";
    return;
  }

  // preview
  const r = new FileReader();
  r.onload = () => {
    previewEl.innerHTML = `<img src="${r.result}">`;
  };
  r.readAsDataURL(file);
};

async function uploadFoto(file){
  statusEl.textContent="Upload foto...";
  const r=new FileReader();
  return new Promise(res=>{
    r.onload=async()=>{
      const o=await fetch(GAS_URL,{
        method:"POST",
        body:JSON.stringify({
          action:"upload",
          name:file.name,
          mime:file.type,
          data:r.result.split(",")[1]
        })
      });
      const j=await o.json();
      res(j.url);
    };
    r.readAsDataURL(file);
  });
}

/* ===== SIMPAN ===== */
btnSimpan.onclick=async()=>{
if(!fotoEl.files[0]){
  errorEl.textContent = "Foto kegiatan wajib diambil dari kamera";
  return;
}

  try{
    let fotoUrl="";
    if(fotoEl.files[0]) fotoUrl=await uploadFoto(fotoEl.files[0]);

    await addDoc(collection(db,"jurnal"),{
      lembagaId,
      namaLembaga,
      guruId:guruEl.value,
      namaGuru:guruEl.options[guruEl.selectedIndex].text,
      kelasId:kelasEl.value,
      namaKelas:kelasEl.options[kelasEl.selectedIndex].text,
      rombelId:rombelEl.value,
      namaRombel:rombelEl.options[rombelEl.selectedIndex].text,
      mapelId:mapelEl.value,
      namaMapel:mapelEl.options[mapelEl.selectedIndex].text,
      catatan:catatanEl.value,
      hadir:+hadirEl.value,
      absen:+absenEl.value,
      foto:fotoUrl,
      tanggal:new Date()
    });

    alert("Jurnal tersimpan");
    location.reload();
  }catch(e){
    errorEl.textContent=e;
  }
};

kelasEl.onchange=loadRombel;


function driveThumb(url, size = 300){
  if(!url) return "";
  if(url.includes("thumbnail")) return url;
  if(url.includes("uc?id=")){
    return url.replace(
      "https://drive.google.com/uc?id=",
      "https://drive.google.com/thumbnail?id="
    ) + "&sz=w" + size;
  }
  return url;
}

window.addEventListener("load", async () => {
  const kode = localStorage.getItem("kodeLembaga");
  if(!kode) return;

  kodeEl.value = kode;
  btnMasuk.click();
});


document.getElementById("btnGantiLembaga").onclick = () => {
  if(!confirm("Ganti lembaga?")) return;
  localStorage.removeItem("kodeLembaga");
  location.reload();
};




</script>

</body>
</html>
