<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Master Rombel</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:Arial, sans-serif;
  background:#f4f6f8;
  padding:20px
}
.card{
  max-width:560px;
  margin:auto;
  background:#fff;
  padding:20px;
  border-radius:8px
}
label{
  font-weight:bold;
  display:block;
  margin-top:10px
}
input,select,textarea,button{
  width:100%;
  padding:8px;
  margin-top:5px;
  font-family:inherit
}
textarea{resize:vertical}
button{
  background:#2e7d32;
  color:#fff;
  border:none;
  margin-top:15px;
  cursor:pointer
}
button.secondary{background:#757575}
button.danger{background:#c62828}
button.small{
  width:auto;
  padding:4px 8px;
  font-size:12px
}
ul{list-style:none;padding:0;margin-top:10px}
li{
  display:flex;
  align-items:center;
  gap:8px;
  border-bottom:1px solid #eee;
  padding:6px 0
}
.error{
  color:#c62828;
  font-size:12px;
  margin-top:6px
}
.note{
  font-size:12px;
  color:#555;
  margin-top:4px
}
</style>
</head>
<body>

<div class="card">
<h2 align="center">Master Rombel</h2>

<label>Pilih Lembaga</label>
<select id="pilihLembaga">
  <option value="">-- Pilih Lembaga --</option>
</select>

<label>Pilih Kelas</label>
<select id="pilihKelas">
  <option value="">-- Pilih Kelas --</option>
</select>

<label>Nama Rombel</label>
<textarea id="namaRombel" rows="5"
placeholder="1 baris = 1 rombel
Contoh:
Rombel A
Rombel B
Rombel C"></textarea>
<div class="note">Saat edit, hanya 1 rombel</div>

<button id="btnSimpan">Simpan Rombel</button>
<button id="btnBatal" class="secondary" style="display:none">Batal</button>

<div class="error" id="error"></div>

<hr>
<h3>Daftar Rombel</h3>
<div id="listRombel">Pilih lembaga dan kelas</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs,
  doc, updateDoc, getDoc, deleteDoc,
  query, where
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ===== FIREBASE ===== */
const firebaseConfig = {
  apiKey:"AIzaSyCcjNKkW3ASw46yKXshKIa6qkrJMNVlep8",
  authDomain:"jurnalmengajar-d4e8e.firebaseapp.com",
  projectId:"jurnalmengajar-d4e8e"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ===== ELEMENT ===== */
const pilihLembagaEl = document.getElementById("pilihLembaga");
const pilihKelasEl  = document.getElementById("pilihKelas");
const namaRombelEl  = document.getElementById("namaRombel");
const btnSimpan     = document.getElementById("btnSimpan");
const btnBatal      = document.getElementById("btnBatal");
const listRombelEl  = document.getElementById("listRombel");
const errorEl       = document.getElementById("error");

/* ===== STATE ===== */
let editId = null;

/* ===== LOAD LEMBAGA ===== */
async function loadLembaga(){
  const snap = await getDocs(collection(db,"lembaga"));
  let opt='<option value="">-- Pilih Lembaga --</option>';
  snap.forEach(d=>{
    const x=d.data();
    opt+=`<option value="${d.id}">${x.nama}</option>`;
  });
  pilihLembagaEl.innerHTML=opt;
}
loadLembaga();

/* ===== LOAD KELAS ===== */
async function loadKelas(lembagaId){
  pilihKelasEl.innerHTML='<option value="">-- Pilih Kelas --</option>';
  if(!lembagaId) return;

  const q=query(
    collection(db,"kelas"),
    where("lembagaId","==",lembagaId)
  );
  const snap=await getDocs(q);

  snap.forEach(d=>{
    const x=d.data();
    pilihKelasEl.innerHTML+=
      `<option value="${d.id}">${x.namaKelas}</option>`;
  });
}

/* ===== LOAD ROMBEL ===== */
async function loadRombel(lembagaId,kelasId){
  if(!lembagaId || !kelasId){
    listRombelEl.innerHTML="Pilih lembaga dan kelas";
    return;
  }

  const q=query(
    collection(db,"rombel"),
    where("lembagaId","==",lembagaId),
    where("kelasId","==",kelasId)
  );
  const snap=await getDocs(q);

  if(snap.empty){
    listRombelEl.innerHTML="Belum ada rombel";
    return;
  }

  let html="<ul>";
  snap.forEach(d=>{
    const x=d.data();
    html+=`
      <li>
        ${x.namaRombel}
        <button class="small" onclick="editRombel('${d.id}','${x.namaRombel}')">Edit</button>
        <button class="small danger" onclick="hapusRombel('${d.id}')">Hapus</button>
      </li>`;
  });
  html+="</ul>";
  listRombelEl.innerHTML=html;
}

/* ===== SIMPAN ===== */
async function simpanRombel(){
  errorEl.textContent="";
  const lembagaId = pilihLembagaEl.value;
  const kelasId   = pilihKelasEl.value;
  const teks      = namaRombelEl.value.trim();

  if(!lembagaId || !kelasId || !teks){
    errorEl.textContent="Lengkapi semua data";
    return;
  }

  /* EDIT */
  if(editId){
    const nama = teks.split("\n")[0].trim();
    await updateDoc(doc(db,"rombel",editId),{ namaRombel:nama });
    resetForm();
    loadRombel(lembagaId,kelasId);
    return;
  }

  /* TAMBAH BANYAK */
  const daftar = teks
    .split("\n")
    .map(x=>x.trim())
    .filter(x=>x);

  for(const namaRombel of daftar){
    await addDoc(collection(db,"rombel"),{
      lembagaId,
      kelasId,
      namaRombel,
      dibuat:new Date()
    });
  }

  resetForm();
  loadRombel(lembagaId,kelasId);
}

/* ===== EDIT ===== */
window.editRombel=(id,nama)=>{
  editId=id;
  namaRombelEl.value=nama;
  btnSimpan.textContent="Update Rombel";
  btnBatal.style.display="block";
};

/* ===== HAPUS ===== */
window.hapusRombel=async(id)=>{
  if(!confirm("Hapus rombel ini?")) return;
  await deleteDoc(doc(db,"rombel",id));
  loadRombel(pilihLembagaEl.value,pilihKelasEl.value);
};

/* ===== RESET ===== */
function resetForm(){
  editId=null;
  namaRombelEl.value="";
  btnSimpan.textContent="Simpan Rombel";
  btnBatal.style.display="none";
}

/* ===== EVENT ===== */
btnSimpan.onclick=simpanRombel;
btnBatal.onclick=resetForm;

pilihLembagaEl.onchange=()=>{
  loadKelas(pilihLembagaEl.value);
  listRombelEl.innerHTML="Pilih kelas";
};

pilihKelasEl.onchange=()=>{
  loadRombel(pilihLembagaEl.value,pilihKelasEl.value);
};
</script>

</body>
</html>
